# æ•°æ®é›†é¢„å¤„ç†æ“ä½œæŒ‡å—

## æ¦‚è¿°

æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜å¦‚ä½•å°†ç°æœ‰æ•°æ®é›†é¢„å¤„ç†ä¸ºç¬¦åˆé¡¹ç›®è¦æ±‚çš„æ ¼å¼ã€‚

---

## å½“å‰æ•°æ®é›†é—®é¢˜

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | å½±å“ |
|------|----------|------|
| éªŒè¯é›†å›¾ç‰‡ä¸¥é‡ç¼ºå¤± (90%) | ğŸ”´ ä¸¥é‡ | æ— æ³•æ­£ç¡®è¯„ä¼°æ¨¡å‹ |
| å›¾ç‰‡-æ ‡ç­¾æ•°é‡ä¸åŒ¹é… | ğŸ”´ ä¸¥é‡ | è®­ç»ƒæ—¶ä¼šæŠ¥é”™ |
| ç±»åˆ«IDè¶…å‡ºé…ç½®èŒƒå›´ (40ç±» vs 29ç±») | ğŸŸ¡ ä¸­ç­‰ | éƒ¨åˆ†æ ‡æ³¨è¢«å¿½ç•¥ |
| ç±»åˆ«åˆ†å¸ƒä¸å‡è¡¡ | ğŸŸ¢ è½»å¾® | æ¨¡å‹åå‘å¤šæ•°ç±» |

---

## é¢„å¤„ç†æµç¨‹

### æ­¥éª¤ 1: æ¨¡æ‹Ÿè¿è¡Œï¼ˆé¢„è§ˆæ“ä½œï¼‰

```powershell
cd d:\Data\code\YOLOv8
python dataset_preprocessor.py
```

è¿™å°†åˆ†ææ•°æ®é›†å¹¶æ˜¾ç¤ºå°†è¦æ‰§è¡Œçš„æ“ä½œï¼Œä½†ä¸ä¼šå®é™…ä¿®æ”¹ä»»ä½•æ–‡ä»¶ã€‚

### æ­¥éª¤ 2: æ‰§è¡Œå®é™…é¢„å¤„ç†

```powershell
python dataset_preprocessor.py --execute
```

å¯é€‰å‚æ•°ï¼š
- `--output datasets/my_dataset`ï¼šè‡ªå®šä¹‰è¾“å‡ºç›®å½•
- `--val-ratio 0.15`ï¼šè°ƒæ•´éªŒè¯é›†æ¯”ä¾‹ï¼ˆé»˜è®¤20%ï¼‰

### æ­¥éª¤ 3: éªŒè¯é¢„å¤„ç†ç»“æœ

```powershell
# æ£€æŸ¥è¾“å‡ºç›®å½•ç»“æ„
dir datasets\processed\images\train | Measure-Object
dir datasets\processed\images\val | Measure-Object
dir datasets\processed\labels\train | Measure-Object
dir datasets\processed\labels\val | Measure-Object
```

### æ­¥éª¤ 4: åº”ç”¨æ–°é…ç½®

```powershell
# å¤‡ä»½åŸé…ç½®
copy Config.py Config.py.backup

# ä½¿ç”¨æ–°é…ç½®
copy datasets\processed\Config.py Config.py
```

### æ­¥éª¤ 5: ä¿®æ”¹è®­ç»ƒè„šæœ¬

ç¼–è¾‘ `train.py`ï¼Œå°†æ•°æ®é›†è·¯å¾„æ”¹ä¸ºï¼š

```python
# ä¿®æ”¹å‰
data='datasets/data.yaml'

# ä¿®æ”¹å
data='datasets/processed/data.yaml'
```

### æ­¥éª¤ 6: å¼€å§‹è®­ç»ƒ

```powershell
python train.py
```

---

## é¢„å¤„ç†è„šæœ¬è¯´æ˜

### è„šæœ¬åŠŸèƒ½

`dataset_preprocessor.py` æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. **åˆ†ææ•°æ®é›†** - ç»Ÿè®¡å›¾ç‰‡ã€æ ‡ç­¾ã€åŒ¹é…æƒ…å†µå’Œç±»åˆ«åˆ†å¸ƒ
2. **æ¸…ç†å­¤ç«‹æ ‡ç­¾** - åˆ é™¤æ²¡æœ‰å¯¹åº”å›¾ç‰‡çš„æ ‡ç­¾æ–‡ä»¶
3. **é‡æ–°åˆ’åˆ†æ•°æ®é›†** - æŒ‰80/20æ¯”ä¾‹é‡æ–°åˆ†é…è®­ç»ƒ/éªŒè¯é›†
4. **ç”Ÿæˆé…ç½®æ–‡ä»¶** - åˆ›å»º `data.yaml` å’Œ `Config.py`

### é…ç½®é€‰é¡¹

åœ¨è„šæœ¬å¼€å¤´å¯ä»¥ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š

```python
# éªŒè¯é›†æ¯”ä¾‹
VAL_RATIO = 0.2

# éšæœºç§å­ï¼ˆç¡®ä¿å¯å¤ç°ï¼‰
RANDOM_SEED = 42

# ç±»åˆ«æ˜ å°„
FULL_CLASS_NAMES = {
    0: 'vegetable_leaves',
    # ... æ›´å¤šç±»åˆ«
}
```

---

## æ•°æ®æ ¼å¼è¯´æ˜

### YOLOæ ‡ç­¾æ ¼å¼

æ¯è¡Œæ ¼å¼ï¼š`<class_id> <x_center> <y_center> <width> <height>`

ç¤ºä¾‹ï¼š
```
0 0.5 0.5 0.3 0.4
```

å«ä¹‰ï¼š
- `0`ï¼šç±»åˆ«ID
- `0.5 0.5`ï¼šè¾¹ç•Œæ¡†ä¸­å¿ƒåæ ‡ï¼ˆå½’ä¸€åŒ–ï¼Œç›¸å¯¹äºå›¾ç‰‡å®½é«˜ï¼‰
- `0.3 0.4`ï¼šè¾¹ç•Œæ¡†å®½åº¦å’Œé«˜åº¦ï¼ˆå½’ä¸€åŒ–ï¼‰

### ç›®å½•ç»“æ„

```
datasets/processed/
â”œâ”€â”€ images/
â”‚   â”œâ”€â”€ train/      # è®­ç»ƒé›†å›¾ç‰‡
â”‚   â””â”€â”€ val/        # éªŒè¯é›†å›¾ç‰‡
â”œâ”€â”€ labels/
â”‚   â”œâ”€â”€ train/      # è®­ç»ƒé›†æ ‡ç­¾
â”‚   â””â”€â”€ val/        # éªŒè¯é›†æ ‡ç­¾
â”œâ”€â”€ data.yaml       # æ•°æ®é›†é…ç½®
â””â”€â”€ Config.py       # ç¨‹åºé…ç½®
```

---

## å¯èƒ½é‡åˆ°çš„é—®é¢˜

### é—®é¢˜ 1: å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒ

**ç—‡çŠ¶**ï¼šéƒ¨åˆ†å›¾ç‰‡æ— æ³•åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨è„šæœ¬ä¸­æ·»åŠ æ”¯æŒçš„æ‰©å±•å
```python
def get_image_extensions():
    return ['.jpg', '.jpeg', '.png', '.bmp', '.webp', '.tiff']
```

### é—®é¢˜ 2: å†…å­˜ä¸è¶³

**ç—‡çŠ¶**ï¼šå¤„ç†å¤§é‡æ–‡ä»¶æ—¶ç¨‹åºå¡é¡¿

**è§£å†³æ–¹æ¡ˆ**ï¼šåˆ†æ‰¹å¤„ç†æˆ–å¢åŠ ç³»ç»Ÿå†…å­˜

### é—®é¢˜ 3: ç±»åˆ«IDä¸è¿ç»­

**ç—‡çŠ¶**ï¼šè®­ç»ƒæ—¶æŠ¥ç±»åˆ«æ•°é‡é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ç±»åˆ«é‡æ˜ å°„åŠŸèƒ½

```python
# åœ¨è„šæœ¬ä¸­æ·»åŠ é‡æ˜ å°„é€»è¾‘
REMAP_CLASSES = {
    39: 28,  # å°†ç±»åˆ«39æ˜ å°„åˆ°28ï¼ˆå…¶ä»–åƒåœ¾ï¼‰
}
```

### é—®é¢˜ 4: éªŒè¯é›†è¿‡å°

**ç—‡çŠ¶**ï¼šéªŒè¯æŒ‡æ ‡ä¸ç¨³å®š

**è§£å†³æ–¹æ¡ˆ**ï¼šå¢åŠ éªŒè¯é›†æ¯”ä¾‹
```powershell
python dataset_preprocessor.py --execute --val-ratio 0.25
```

### é—®é¢˜ 5: ç±»åˆ«ä¸å‡è¡¡

**ç—‡çŠ¶**ï¼šæ¨¡å‹å¯¹å°‘æ•°ç±»è¯†åˆ«æ•ˆæœå·®

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å¯¹å°‘æ•°ç±»è¿›è¡Œæ•°æ®å¢å¼º
2. ä½¿ç”¨åŠ æƒæŸå¤±å‡½æ•°
3. ä½¿ç”¨è¿‡é‡‡æ ·ç­–ç•¥

```python
# åœ¨train.pyä¸­æ·»åŠ 
model.train(
    data='datasets/processed/data.yaml',
    epochs=100,
    imgsz=640,
    # ä½¿ç”¨ç±»åˆ«æƒé‡
    cls=0.5,  # ç±»åˆ«æŸå¤±æƒé‡
)
```

---

## æ•°æ®å¢å¼ºå»ºè®®

åœ¨ `train.py` ä¸­å¯ç”¨å†…ç½®æ•°æ®å¢å¼ºï¼š

```python
model.train(
    data='datasets/processed/data.yaml',
    epochs=100,
    imgsz=640,
    # æ•°æ®å¢å¼ºå‚æ•°
    hsv_h=0.015,      # è‰²è°ƒå¢å¼º
    hsv_s=0.7,        # é¥±å’Œåº¦å¢å¼º
    hsv_v=0.4,        # äº®åº¦å¢å¼º
    degrees=15,       # æ—‹è½¬è§’åº¦
    translate=0.1,    # å¹³ç§»
    scale=0.5,        # ç¼©æ”¾
    fliplr=0.5,       # æ°´å¹³ç¿»è½¬æ¦‚ç‡
    mosaic=1.0,       # Mosaicå¢å¼º
    mixup=0.1,        # MixUpå¢å¼º
)
```

---

## éªŒè¯æ•°æ®è´¨é‡

### æ£€æŸ¥å›¾ç‰‡-æ ‡ç­¾åŒ¹é…

```python
from pathlib import Path

images = set(p.stem for p in Path('datasets/processed/images/train').glob('*.*'))
labels = set(p.stem for p in Path('datasets/processed/labels/train').glob('*.txt'))

print(f"å›¾ç‰‡: {len(images)}")
print(f"æ ‡ç­¾: {len(labels)}")
print(f"åŒ¹é…: {len(images & labels)}")
print(f"æ— æ ‡ç­¾å›¾ç‰‡: {len(images - labels)}")
print(f"æ— å›¾ç‰‡æ ‡ç­¾: {len(labels - images)}")
```

### æ£€æŸ¥æ ‡ç­¾æ ¼å¼

```python
import os

def validate_labels(labels_dir):
    errors = []
    for label_file in Path(labels_dir).glob('*.txt'):
        with open(label_file, 'r') as f:
            for i, line in enumerate(f, 1):
                parts = line.strip().split()
                if len(parts) != 5:
                    errors.append(f"{label_file.name}:{i} - å­—æ®µæ•°é‡é”™è¯¯")
                    continue
                try:
                    class_id = int(parts[0])
                    coords = [float(x) for x in parts[1:]]
                    if not all(0 <= c <= 1 for c in coords):
                        errors.append(f"{label_file.name}:{i} - åæ ‡è¶…å‡ºèŒƒå›´")
                except ValueError:
                    errors.append(f"{label_file.name}:{i} - æ ¼å¼é”™è¯¯")
    return errors

errors = validate_labels('datasets/processed/labels/train')
print(f"å‘ç° {len(errors)} ä¸ªé”™è¯¯")
for e in errors[:10]:
    print(f"  {e}")
```

---

## å®Œæ•´æµç¨‹ç¤ºä¾‹

```powershell
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd d:\Data\code\YOLOv8

# 2. æ¨¡æ‹Ÿè¿è¡Œé¢„å¤„ç†
python dataset_preprocessor.py

# 3. ç¡®è®¤æ— è¯¯åæ‰§è¡Œ
python dataset_preprocessor.py --execute

# 4. éªŒè¯ç»“æœ
python -c "from pathlib import Path; print(f'Train: {len(list(Path(\"datasets/processed/images/train\").glob(\"*.*\")))}'); print(f'Val: {len(list(Path(\"datasets/processed/images/val\").glob(\"*.*\")))}')"

# 5. åº”ç”¨é…ç½®
copy datasets\processed\Config.py Config.py

# 6. å¼€å§‹è®­ç»ƒ
python train.py
```

---

## è”ç³»æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. Pythonç‰ˆæœ¬ï¼š3.8+
2. ä¾èµ–ï¼špathlib, shutil, random (æ ‡å‡†åº“)
3. ç£ç›˜ç©ºé—´ï¼šè‡³å°‘éœ€è¦åŸæ•°æ®é›†2å€ç©ºé—´
